/**
 * sofa-basket-service - v0.4.0 - Tue Feb 17 2015 12:16:52 GMT+0100 (CET)
 * http://www.sofa.io
 *
 * Copyright (c) 2014 CouchCommerce GmbH (http://www.couchcommerce.com / http://www.sofa.io) and other contributors
 * THIS SOFTWARE CONTAINS COMPONENTS OF THE SOFA.IO COUCHCOMMERCE SDK (WWW.SOFA.IO)
 * IT IS PROVIDED UNDER THE LICENSE TERMS OF THE ATTACHED LICENSE.TXT.
 */
!function(t,e,n){"use strict";t.define("sofa.BasketService",function(e,i,r){function o(e){return e?e.map(function(e){delete e.$$hashKey;var n=t.Util.extend(new t.models.BasketItem,e);return n.product&&(n.product=t.Util.extend(new t.models.Product,n.product)),n}):e}var c={},u="basketService_",a=u+"items",s=u+"coupons",d=o(e.get(a))||[],p=o(e.get(s))||[],f=r&&cc.Util.isFunction(r.productIdentityFn)?r.productIdentityFn:function(t,e,n,i){var r=e&&e.variantID,o=i&&i.variantID,c=e&&e.optionID,u=i&&i.optionID;return t.id===n.id&&r===o&&c===u},m=i.get("shippingCost"),l=i.get("shippingTax"),h=i.get("freeShippingFrom");t.observable.mixin(c);var v=function(){e.set(a,d),e.set(s,p)};v(),c.addItem=function(e,n,i){if(e.isOutOfStock())throw new Error("product out of stock");if(!g(e,n,i))throw new Error("exceeds available stock");var r=c.find(y(e,i)),o=!t.Util.isUndefined(r);return o||(r=new t.models.BasketItem,d.push(r)),r.product=e,r.quantity=r.quantity+n,r.variant=i,e.hasInfiniteStock()||i?null!==i&&cc.Util.isObject(i)&&cc.Util.isNumeric(i.stock)&&(i.stock=i.stock-n):e.qty=e.qty-n,v(),c.emit("itemAdded",c,r),r},c.canBeIncreasedBy=function(t,e){return g(t.product,e,t.variant)};var g=function(t,e,n){return n&&cc.Util.isNumeric(n.stock)?n.stock-e>=0:t.hasInfiniteStock()||t.qty-e>=0};c.addCoupon=function(t){var e=cc.Util.find(p,function(e){return e.code===t.code});e||(p.push(t),v(),c.emit("couponAdded",c,t))},c.removeCoupon=function(t){var e=cc.Util.find(p,function(e){return e.code===t});cc.Util.Array.remove(p,e),v(),c.emit("couponRemoved",c,e)},c.getActiveCoupons=function(){return p},c.increaseOne=function(t){return c.increase(t,1)},c.increase=function(t,e){return c.addItem(t.product,e,t.variant)},c.exists=function(e,n){var i=c.find(y(e,n));return!t.Util.isUndefined(i)};var y=function(t,e){return function(n){return f(t,e,n.product,n.variant)}};return c.removeItem=function(e,n,i){var r=c.find(y(e,i));if(!r)throw new Error("Product id: "+e.id+" , variant: "+i+"  does not exist in the basket");if(r.quantity<n)throw new Error("remove quantity is higher than existing quantity");return r.quantity=r.quantity-n,0===r.quantity&&t.Util.Array.remove(d,r),e.hasInfiniteStock()||i?cc.Util.isObject(i)&&cc.Util.isNumeric(i.stock)&&(i.stock=i.stock+n):e.qty=e.qty+n,v(),c.emit("itemRemoved",c,r),r},c.decreaseOne=function(t){return c.decrease(t,1)},c.decrease=function(t,e){return c.removeItem(t.product,e,t.variant)},c.clear=function(){return d.length=0,p.length=0,v(),c.emit("cleared",c),c},c.clearCoupons=function(){return p.length=0,v(),c.emit("clearedCoupons",c),c},c.find=function(e){return t.Util.find(d,e)},c.getItems=function(){return d},c.isEmpty=function(){return 0===d.length},c.getSummary=function(e){var i=m||0,r=l,o=h,c=0,u=0,a=0,s=0,f=e&&e.paymentMethod&&t.Util.isNumber(e.paymentMethod.surcharge)?e.paymentMethod.surcharge:0,v=e&&e.paymentMethod&&t.Util.isNumber(e.paymentMethod.surcharge_percentage)?e.paymentMethod.surcharge_percentage:0,g=0,y=function(t,e,n){return parseFloat(t*e/(100+e)*100/100)*n};d.forEach(function(t){var e=parseInt(t.quantity,10),n=t.product,i=t.getPrice(),r=parseInt(n.tax,10);c+=e,u+=i*e,a+=y(i,r,e)}),i=null!==o&&o!==n&&u>=o?0:i,e&&e.shippingMethod&&t.Util.isNumber(e.shippingMethod.price)&&(i=e.shippingMethod.price),g=u+s,v&&(f=g*(v/100)),g+=i+f,p.forEach(function(e){g-=parseFloat(e.amount),e.tax=t.Util.isNumeric(e.tax)?e.tax:19,a-=y(e.amount,e.tax,1)}),a+=y(i,r,1);var U={quantity:c,sum:t.Util.round(u,2),sumStr:u.toFixed(2),vat:t.Util.round(a,2),vatStr:a.toFixed(2),shipping:t.Util.round(i,2),shippingStr:i.toFixed(2),surcharge:t.Util.round(f,2),surchargeStr:f.toFixed(2),discount:t.Util.round(s,2),total:t.Util.round(g,2),totalStr:g.toFixed(2),shippingTax:r};return U},c})}(sofa,document);